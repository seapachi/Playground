<!-- v12  c2-b4(max)ã€€20å• -->
<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guess A Note</title>
  <!-- Google Fonts ã‚’è¿½åŠ  -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
<style>
    /* å…¨ä½“ã‚³ãƒ³ãƒ†ãƒŠã®è¨­å®š */
    .header {
    display: flex;          /* æ¨ªä¸¦ã³ã«ã™ã‚‹ */
    align-items: center;    /* ç¸¦æ–¹å‘ã®ä¸­å¤®æƒãˆ */
    justify-content: space-between; /* ä½™ç™½ã‚’å‡ç­‰é…ç½® */
    gap: 10px;              /* ã‚¢ã‚¤ãƒ†ãƒ é–“ã®é–“éš” */
    /* font-size: 1.5em; */
    }

    /* ã‚¹ã‚³ã‚¢è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .score-display {
      width:300px;
      align-items: center;    /* ç¸¦æ–¹å‘ã®ä¸­å¤®æƒãˆ */
      font-size: 1.2em;
      /* font-weight: bold; */
      /* color: #a855f7; */
      margin: 10  10;
      padding: 0;
      /* background-color: #f8f9fa; */
      /* background-color: blue; */
      /* border-radius: 12px; */
      margin: bottom 5px;
      /* box-shadow: 0 2px 4px rgba(0,0,0,0.1); */
      text-align: right;
    }

    .container {
      width: 350px;
      height: 640px;
      margin: 0 auto;
      padding: 20px;
      overflow: hidden;
      position: relative;
      border-radius: 16px;
      background: white;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1)
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚„ãƒœã‚¿ãƒ³ãªã©ã¯ãã®ã¾ã¾ã§ã‚‚ã‚ˆã„ãŒã€å¿…è¦ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚„ãƒãƒ¼ã‚¸ãƒ³ã‚‚èª¿æ•´ */
    .staff-container #staff {
      width: 300px;
      /* 360px ã«åã¾ã‚‹ã‚ˆã†ã«ä½™ç™½ã‚’ã¨ã‚‹ */
      height: 180px;
      margin: 0 auto;
      background: #f8f9fa;
      /* background: blue; */
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
      }

    /* ãƒªã‚»ãƒƒãƒˆã¨åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      /* background: linear-gradient(135deg, #f5f7fa, #c3cfe2); */
      background: linear-gradient(135deg, #f0e8ff, #d9caff);
      color: #333;
      text-align: center;
      padding: 10px 0 0 0;
    }

    h2 {
      margin-bottom: 20px;
      font-weight: 600;
    }

    button {
      padding: 5px 5px;
      margin: 10px;
      border: none;
      /* height: 3em; */
      border-radius: 5px;
      /* background-color: #007BFF; */
      background-color: #a855f7;
      color: white;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
    }

    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }

    button:hover:not(:disabled) {
      /* background-color: #0056b3; */
      background-color:  #9333ea;
      transform: translateY(-2px);
    }

    /* ãƒ”ã‚¢ãƒã‚¹ã‚¿ã‚¤ãƒ« */
    .piano {
      position: relative;
      width: 300px;
      height: 140px;
      margin: 10px auto;
      padding: 10px;  /* ãƒ”ã‚¢ãƒã®å¤–å´ã«ä½™ç™½ã‚’è¨­å®š   */
      background: #f8f9fa;
      border-radius: 12px;

    }

    /* ç™½éµ */
    .piano .key:not(.black) {
      width: 40px;
      height: 120px;
      border: 1px solid #999;
      background-color: white;
      border-radius: 4px;
      float: left;
      position: relative;
      line-height: 120px;
      font-size: 1em;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s, box-shadow 0.2s;
      z-index: 1;
    }

    /* é»’éµ */
    .piano .key.black {
      width: 28px;
      height: 80px;
      background-color: #333;
      border: 1px solid #444;
      border-radius: 4px;
      position: absolute;
      top: -10;
      z-index: 2;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s, box-shadow 0.2s;
    }

    /* é»’éµã®é…ç½®ï¼šHTMLæœ«å°¾ã«ã¾ã¨ã‚ã¦ã‚ã‚‹å ´åˆã¯ã€Œ8ç•ªç›®ã€œ12ç•ªç›®ã€ãŒé»’éµ */
    .piano .key:nth-child(8) {
      /* 1ç•ªç›®ã®é»’éµ (C#) */
      left: 38px;
    }

    .piano .key:nth-child(9) {
      /* 2ç•ªç›®ã®é»’éµ (D#) */
      left: 78px;
    }

    .piano .key:nth-child(10) {
      /* 3ç•ªç›®ã®é»’éµ (F#) */
      left: 158px;
    }

    .piano .key:nth-child(11) {
      /* 4ç•ªç›®ã®é»’éµ (G#) */
      left: 198px;
    }

    .piano .key:nth-child(12) {
      /* 5ç•ªç›®ã®é»’éµ (A#) */
      left: 238px;
    }

    /* ã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .piano .key:active {
      background-color: #e0e0e0;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
    }

    .piano .key.black:active {
      background-color: #555;
    }

    /* æ¥½è­œè¡¨ç¤ºé ˜åŸŸ */
    .staff-container #staff {
      display: flex;
      justify-content: center;
      width: 300px;
      height: 180px;
      margin: 0 auto;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .message {
      font-size: 1.5em;
      margin: 20px;
      height: 3em; /* å›ºå®šã®é«˜ã•ã‚’è¨­å®š */
      display: flex; /* ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãƒœãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨ */
      align-items: center; /* å‚ç›´æ–¹å‘ã®ä¸­å¤®æƒãˆ */
      justify-content: center; /* æ°´å¹³æ–¹å‘ã®ä¸­å¤®æƒãˆ */
      word-wrap: break-word; /* é•·ã„å˜èªã‚’æŠ˜ã‚Šè¿”ã™ */
      overflow-wrap: break-word; /* é•·ã„å˜èªã‚’æŠ˜ã‚Šè¿”ã™ï¼ˆæ–°ã—ã„ä»•æ§˜ï¼‰ */
      white-space: normal; /* ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ˜ã‚Šè¿”ã™ */
      width: 80%; /* å¹…ã‚’è¦ªè¦ç´ ã„ã£ã±ã„ã« */
    }

    /* çµ±è¨ˆæƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .result-container {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      text-align: center;
      width: 90%;
      max-width: 320px;
      z-index: 100;
      animation: fadeIn 0.5s;
      font-size:1em
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translate(-50%, -60%);
      }

      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }

    /* å ±é…¬ç”»åƒ */
    .reward-image {
      display: none;
      position: absolute;
      top: 40%;
      left: 70%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: 200px;
      border-radius: 50%;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }

    /* è¡¨ç¤ºæ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .reward-image.show {
      display: block;
      animation: slideUpFade 0.5s ease-out;
    }

    /* éè¡¨ç¤ºæ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .reward-image.hide {
      animation: fadeOut 0.5s ease-out forwards;
    }

    /* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒƒãƒ—ï¼†ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes slideUpFade {
      from {
        opacity: 0;
        transform: translate(-50%, 0%);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }

    /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }
  </style>
</head>

<body>  
  <div class="container">
    <!-- <h2>Guess Notes</h2> -->
     <div class="header">
        <!-- <div style="font-size:1.5em;">Guess Notes</div> -->
        <div style="font-size:1.4em;">ğŸµãŠã‚“ã·ã‚¯ã‚¤ã‚º</div>
        <!-- 1ã¤ã®ãƒœã‚¿ãƒ³ã§ã‚¹ã‚¿ãƒ¼ï¼†éŸ³ã‚’æœ‰åŠ¹åŒ– -->
        <button id="startButton" style="height: 3em; ">ã‚¹ã‚¿ãƒ¼ãƒˆ<br><div style="font-size:0.8em;">ï¼ˆãŠã¨ãŒã§ã‚‹ã‚ˆï¼‰</div></button>
        <!-- ã‚²ãƒ¼ãƒ ã‚’é€”ä¸­çµ‚äº†ã§ãã‚‹ãƒœã‚¿ãƒ³ã€‚æœ€åˆã¯éè¡¨ç¤º -->
        <button id="endGameButton" style="display:none; height: 3em;">ã—ã‚…ã†ã‚Šã‚‡ã†</button>
     </div>
     
     <!-- ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
     <div id="scoreDisplay" class="score-display">0ã‚³ãƒ³ãƒœã€€0ã¦ã‚“</div>
     <div id="scoreDisplay" class="score-display"></div>
     
    <!-- çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ã‚¨ãƒªã‚¢ -->
    <div id="resultContainer" class="result-container">
      <div class="result-content">
        <p id="resultText"></p>
        <!-- ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹ãƒœã‚¿ãƒ³ -->
        <button id="restartButton" onclick="restartGame()">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
        <!-- å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  -->
        <!-- <button id="reviewButton"  onclick="startReviewMode()">ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ï¼<br><div style="font-size:0.8em;">ï¼ˆå¾©ç¿’ï¼‰</div></button> -->
        <button id="reviewButton"  onclick="startReviewMode()">ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ï¼ï¼ˆå¾©ç¿’ï¼‰</button>
        <!-- ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã™ã‚‹ãƒœã‚¿ãƒ³ -->
        <button onclick="exitGame()">çµ‚äº†</button>
      </div>
    </div>

    <div class="staff-container">
      
      <div id="staff"></div>
    </div>
    <div class="message" id="message">ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­</div>
    <img id="rewardImage" class="reward-image" src="https://via.placeholder.com/300" alt="Reward">

    <!-- ç™½éµ7ã¤ã€é»’éµ5ã¤ã‚’ã¾ã¨ã‚ã¦æœ€å¾Œã« -->
    <div class="piano">
      <!-- ç™½éµ (1ã€œ7ç•ªç›®) -->
      <div class="key" data-note="C2">C2</div>
      <div class="key" data-note="D2"></div>
      <div class="key" data-note="E2"></div>
      <div class="key" data-note="F2"></div>
      <div class="key" data-note="G2"></div>
      <div class="key" data-note="A2"></div>
      <div class="key" data-note="B2"></div>
      <!-- é»’éµ (8ã€œ12ç•ªç›®) -->
      <div class="key black" data-note="C#2"></div>
      <div class="key black" data-note="D#2"></div>
      <div class="key black" data-note="F#2"></div>
      <div class="key black" data-note="G#2"></div>
      <div class="key black" data-note="A#2"></div>
    </div>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¹ã‚¿ãƒƒãƒ•ç”Ÿæˆå‰ã« DEFAULT_LINE_SPACING ã‚’è¨­å®š
    Vex.Flow.Stave.DEFAULT_LINE_SPACING = 20;

    // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let reviewMode = false;
    let reviewQuestions = []; // å‡ºé¡Œã™ã‚‹ãƒãƒ¼ãƒˆï¼ˆä¾‹ï¼š"C4"ï¼‰
    let reviewIndex = 0;
    let reviewCorrectCount = 0;
    // å¾©ç¿’å‡ºé¡Œæ•°ï¼ˆã‚ã¨ã‹ã‚‰å¤‰æ›´å¯èƒ½ï¼‰
    const maxReviewQuestions = 3;

    let synth;
    let correctNote;
    let attempts = 0;
    let mistakes = 0;
    let score = 0;
    let combo = 0;  // ã‚³ãƒ³ãƒœæ•°ã‚’è¿½åŠ 
    let responseTimes = [];
    let mistakeCount = {};
    let startTime;
    const maxAttempts = 20;
    const baseScore = 10;
    const fastBonus = 20;
    const penalty = -10;
    const comboBonus = 30;  // ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ã‚’è¿½åŠ ï¼ˆæœªä½¿ç”¨ï¼‰

    // å ±é…¬ç”»åƒã®é…åˆ—ã‚’è¿½åŠ 
    const rewardImages = [
      "png/10_dance.png",
      "png/20_dance.png",
      "png/30_dance.png"
    ];

    // ç”»åƒã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
    function preloadImages() {
      const preloadedImages = [];
      rewardImages.forEach(src => {
        const img = new Image();
        img.src = src;
        preloadedImages.push(img);
      });
      return preloadedImages;
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ç”»åƒã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
    const preloadedImages = preloadImages();

    // éŸ³éšã®ç¯„å›²ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    function generateNoteRange(startNote, endNote) {
      const notes = [];
      const scale = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
      
      // é–‹å§‹éŸ³ã¨çµ‚äº†éŸ³ã®ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã¨éŸ³åã‚’åˆ†è§£
      const startOctave = parseInt(startNote.slice(-1));
      const endOctave = parseInt(endNote.slice(-1));
      const startIndex = scale.indexOf(startNote.charAt(0));
      const endIndex = scale.indexOf(endNote.charAt(0));

      // å„ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã§éŸ³ã‚’ç”Ÿæˆ
      for (let octave = startOctave; octave <= endOctave; octave++) {
        // æœ€åˆã®ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã®å ´åˆ
        if (octave === startOctave) {
          for (let i = startIndex; i < scale.length; i++) {
            notes.push(scale[i] + octave);
          }
        }
        // æœ€å¾Œã®ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã®å ´åˆ
        else if (octave === endOctave) {
          for (let i = 0; i <= endIndex; i++) {
            notes.push(scale[i] + octave);
          }
        }
        // ä¸­é–“ã®ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã®å ´åˆ
        else {
          scale.forEach(note => notes.push(note + octave));
        }
      }
      return notes;
    }

    // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰éŸ³æœ‰åŠ¹åŒ–ï¼‹ã‚²ãƒ¼ãƒ é–‹å§‹
    document.getElementById("startButton").addEventListener("click", async () => {
      await Tone.start(); // AudioContextã‚’æœ‰åŠ¹åŒ–
      alert("éŸ³ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼");
      synth = new Tone.Synth().toDestination();
      // 2ç§’å¾…ã¤
      document.getElementById("message").textContent = "ã‚‚ã‚“ã ã„ã‚’ã˜ã‚…ã‚“ã³ä¸­";

      await new Promise(resolve => setTimeout(resolve, 2000));
      await demoMode();
      resetGame();
      document.getElementById("message").textContent = "ãŠã‚“ã·ã®éŸ³ã‚’ã‚ã¦ã¦ã­";
      await new Promise(resolve => setTimeout(resolve, 1000));
      generateRandomNote();

      // ã‚²ãƒ¼ãƒ é–‹å§‹ã—ãŸã‚‰ã€ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’éš ã—ã€çµ‚äº†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      document.getElementById("startButton").style.display = "none";
      document.getElementById("endGameButton").style.display = "inline-block";
    });

    // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é€”ä¸­çµ‚äº†
    document.getElementById("endGameButton").addEventListener("click", () => {
      endGame(); // é€”ä¸­çµ‚äº†ã§ã‚‚çµæœã‚’è¡¨ç¤º
    });



    function resetGame() {
      attempts = 0;
      mistakes = 0;
      score = 0;
      combo = 0;  // ã‚³ãƒ³ãƒœã‚‚ãƒªã‚»ãƒƒãƒˆ
      responseTimes = [];
      mistakeCount = {};
      document.getElementById("rewardImage").style.display = "none";  // ç”»åƒã‚’éè¡¨ç¤º
      updateScoreDisplay();
    }

    // ã¾ãšplayNoteé–¢æ•°ã‚’Promiseã‚’è¿”ã™ã‚ˆã†ã«ä¿®æ­£
    async function playNote(note) {
      if (Tone.context.state !== "running") {
        await Tone.start();
      }
      if (!synth) return;
      
      return new Promise(resolve => {
        try {
          synth.triggerAttackRelease(note, "8n");
          // éŸ³ã®é•·ã•ï¼ˆ8nï¼‰åˆ†å¾…ã£ã¦ã‹ã‚‰resolveã™ã‚‹
          setTimeout(resolve, Tone.Time('8n').toMilliseconds());
          // setTimeout(resolve, 500);
          
          // setTimeout(resolve, 300);
        } catch (error) {
          console.error("Error playing note:",note, error);
          resolve();
          // setTimeout(resolve,300); // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã§ã‚‚resolveã™ã‚‹
        }
      });
    }

    function drawStaff(note, isDemoMode = false) {
      const staffDiv = document.getElementById("staff");
      staffDiv.innerHTML = "";
      const renderer = new Vex.Flow.Renderer(staffDiv, Vex.Flow.Renderer.Backends.SVG);

      renderer.resize(260, 140);
      const context = renderer.getContext();
      context.svg.style.transform = "scale(1.3, 1.3)";
      context.svg.style.transformOrigin = "0 0";

      // éŸ³ç¬¦ã®ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã‚’å–å¾—ã—ã¦éŸ³éƒ¨è¨˜å·ã‚’æ±ºå®š
      const octave = parseInt(note.split('/')[1]);
      const clef = octave >= 4 ? "treble" : "bass";  // C4ä»¥ä¸Šã¯ãƒˆéŸ³è¨˜å·ã€ãã‚Œä»¥ä¸‹ã¯ãƒ˜éŸ³è¨˜å·

      const stave = new Vex.Flow.Stave(0, 0, 190);
      stave.addClef(clef).setContext(context).draw();

      if (isDemoMode || reviewMode) {
        // éŸ³éƒ¨è¨˜å·ã«å¿œã˜ã¦å‚è€ƒéŸ³ã‚’è¨­å®š
        const referenceNotes = clef === "treble" 
          ? ["c/4", "c/5", "c/6"]  // ãƒˆéŸ³è¨˜å·ã®å ´åˆ
          : ["c/2", "c/3", "c/4"]; // ãƒ˜éŸ³è¨˜å·ã®å ´åˆ

        const refNote = new Vex.Flow.StaveNote({
          keys: referenceNotes,
          duration: "q",
          clef: clef
        });
        refNote.setStyle({ fillStyle: "#a855f7", strokeStyle: "#a855f7" });
        refNote.setStemStyle({ strokeStyle: "transparent" });
        const probNote = new Vex.Flow.StaveNote({
          keys: [note],
          duration: "q",
          clef: clef
        });
        probNote.setStemStyle({ strokeStyle: "transparent" });
        const voice1 = new Vex.Flow.Voice({ num_beats: 2, beat_value: 4 });
        voice1.addTickables([refNote, probNote]);
        new Vex.Flow.Formatter().joinVoices([voice1]).format([voice1], 50);
        voice1.draw(context, stave);
      } else {
        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
        const staveNote = new Vex.Flow.StaveNote({
          keys: [note],
          duration: "q",
          clef: clef
        });
        staveNote.setStemStyle({ strokeStyle: "transparent" });
        const voice = new Vex.Flow.Voice({ num_beats: 1, beat_value: 4 });
        voice.addTickables([staveNote]);
        new Vex.Flow.Formatter().joinVoices([voice]).format([voice], 400);
        voice.draw(context, stave);
      }

      if (isDemoMode) {
        document.getElementById("message").textContent = `${convertNoteToJapanese(note.replace('/', ''))}`;
      }
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å‡ºé¡Œç¯„å›²ã‚’å®šç¾©
    const noteRange = {
      start: 'C2',
      end: 'B5'
    };

    // generateRandomNoteé–¢æ•°ã‚’æ›´æ–°
    function generateRandomNote() {
      if (!reviewMode) {
        // å‡ºé¡Œç¯„å›²ã‚’å¤‰æ•°ã‹ã‚‰å–å¾—
        const notes = generateNoteRange(noteRange.start, noteRange.end);
        let index = Math.floor(Math.random() * notes.length);
        correctNote = notes[index];
      } else {
        if (reviewIndex < reviewQuestions.length) {
          correctNote = reviewQuestions[reviewIndex];
          console.log("reviewCorrectNote=", correctNote);
        } else {
          finishReviewMode();
          return;
        }
      }
      let letter = correctNote.charAt(0);
      let octave = correctNote.slice(1);
      let vexflowNote = letter + "/" + octave;

      let keyboardOctave = octave;
      console.log("octave",octave); // ^^^debug
      console.log("keyboardOctave",keyboardOctave);   // ^^^debug

      // æ›´æ–°ï¼šéµç›¤ã®éŸ³ã‚’è¡¨ç¤ºã™ã‚‹ï¼ˆéµç›¤ã¯ãƒ‰ã‹ã‚‰ã‚·ï¼‹é»’éµã‚‚å«ã‚€ï¼‰
      // 1ã€œ7ç•ªç›®ãŒç™½éµ, 8ã€œ12ç•ªç›®ãŒé»’éµ
      const naturalKeys = ["C", "D", "E", "F", "G", "A", "B"];
      const sharpKeys = ["C#", "D#", "F#", "G#", "A#"];

      // ç™½éµæ›´æ–°ï¼ˆ1ã€œ7ç•ªç›®ï¼‰
      const whiteKeys = document.querySelectorAll('.piano .key:not(.black)');
      whiteKeys.forEach((key, idx) => {
        let noteLetter = naturalKeys[idx];
        if (idx === 0) {
          // å·¦ç«¯ã®ç™½éµã¯å¸¸ã«ãƒ‰ï¼ˆCï¼‰
          key.dataset.note = "C" + keyboardOctave;
          key.textContent = "C" + keyboardOctave;
        } else {
          key.dataset.note = noteLetter + keyboardOctave;
          key.textContent = "";
        }
      });

      // é»’éµæ›´æ–°ï¼ˆ8ã€œ12ç•ªç›®ï¼‰
      const blackKeys = document.querySelectorAll('.piano .key.black');
      blackKeys.forEach((key, idx) => {
        key.dataset.note = sharpKeys[idx] + keyboardOctave;
        key.textContent = ""; // é»’éµã¯æ–‡å­—ã‚’è¡¨ç¤ºã—ãªã„
      });
      document.getElementById("message").textContent = `ã‚ã‹ã‚‹ã‹ãªï¼Ÿ`;
      // Vex.Flow.Stave.DEFAULT_LINE_SPACING = 40; //default 20  
      drawStaff(letter + "/" + octave);
      startTime = Date.now();
    }

    // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼šçµæœç”»é¢ã®ã€Œå¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã§å‘¼ã³å‡ºã™
    function startReviewMode() {
      // ã“ã“ã§ã¯ã€å‰å›ã®ã‚²ãƒ¼ãƒ çµæœã‹ã‚‰ã€Œé–“é•ã„ã®å¤šã‹ã£ãŸéŸ³ãƒˆãƒƒãƒ—3ã€ã¨ã€Œåå¿œãŒé…ã‹ã£ãŸéŸ³ãƒˆãƒƒãƒ—3ã€ã‚’
      // ä»®ã«ãã‚Œãã‚Œ reviewPool1, reviewPool2 ã¨ã—ã¦ä½œæˆã™ã‚‹ä¾‹ã§ã™ã€‚
      // â€»å®Ÿéš›ã¯ endGame() æ™‚ã«è¨ˆç®—ã—ãŸçµæœã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ã™ã‚‹ã‹ã€å†è¨ˆç®—ã—ã¦ãã ã•ã„ã€‚
      let reviewPoolSet = new Set();
      // ã“ã“ã§ã¯ã€mistakeCount ã‹ã‚‰ãƒˆãƒƒãƒ—3ã®éŸ³ã¨ã€responseTimes ã®é…ã„ä¸Šä½3ã‚’ãƒ—ãƒ¼ãƒ«ã¨ã™ã‚‹ä¾‹
      // æ³¨æ„ï¼šresponseTimes ã®ã‚½ãƒ¼ãƒˆçµæœã¯ endGame() å†…ã§ã®ã¿åˆ©ç”¨ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯å˜ç´”ãªä¾‹ã§ã™ã€‚
      // å®Ÿéš›ã«ã¯é©åˆ‡ãªãƒ­ã‚¸ãƒƒã‚¯ã«ã‚ˆã‚Šãƒˆãƒƒãƒ—3ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
      Object.keys(mistakeCount).forEach(note => reviewPoolSet.add(note));
      responseTimes.forEach(rtObj => reviewPoolSet.add(rtObj.note));
      reviewQuestions = Array.from(reviewPoolSet);
      console.log("reviewQuestions=",reviewQuestions) ;  //^^^ debug
      // ã‚‚ã—ãƒ—ãƒ¼ãƒ«ãŒ maxReviewQuestions ã‚ˆã‚Šå¤šã‘ã‚Œã°ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦é¸æŠ
      if (reviewQuestions.length > maxReviewQuestions) {
        reviewQuestions = shuffleArray(reviewQuestions).slice(0, maxReviewQuestions);
      }
      reviewMode = true;
      reviewIndex = 0;
      reviewCorrectCount = 0;
      // çµæœãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
      document.getElementById("resultContainer").style.display = "none";
      console.log("starReviewMode & generateRandomnNote")
      generateRandomNote();
    }

    // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰çµ‚äº†ï¼šå¾©ç¿’çµæœã‚’è¡¨ç¤º
    function finishReviewMode() {
      reviewMode = false;
      let reviewResultMessage = `
        <p>ã‚ˆãã§ãã¾ã—ãŸï¼</p>
      `;
      // <p>æ­£è§£æ•°ï¼š${reviewCorrectCount} / ${maxReviewQuestions}</p>
      document.getElementById("resultText").innerHTML = reviewResultMessage;
      document.getElementById("restartButton").style.display = "inline-block";
      document.getElementById("resultContainer").style.display = "block";
    }

    // å˜ç´”ãªã‚·ãƒ£ãƒƒãƒ•ãƒ«é–¢æ•°
    function shuffleArray(array) {
      let arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function checkAnswer(selectedNote) {
      let responseTime = (Date.now() - startTime) / 1000;
      if (!reviewMode) {
        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
        if (selectedNote === correctNote) {
          let points = responseTime <= 2.0 ? fastBonus : baseScore;
          combo++;  // ã‚³ãƒ³ãƒœæ•°ã‚’å¢—ã‚„ã™
          
          // 3ã®å€æ•°ã®ã‚³ãƒ³ãƒœã§ãƒœãƒ¼ãƒŠã‚¹ã¨ç”»åƒè¡¨ç¤º
          if (combo % 3 === 0) {
            // ãƒœãƒ¼ãƒŠã‚¹ã¯ä¸€æ—¦ãªã—
            // points += comboBonus;
            document.getElementById("message").textContent =
              // `${combo}ã‚³ãƒ³ãƒœï¼ãƒœãƒ¼ãƒŠã‚¹ ${comboBonus}ã¦ã‚“ï¼`;
              `${combo}ã‚³ãƒ³ãƒœï¼`;
            
            // 3å›é€£ç¶šæ­£è§£æ™‚ã«ç”»åƒã‚’è¡¨ç¤º
            const rewardImage = document.getElementById("rewardImage");
            const randomIndex = Math.floor(Math.random() * preloadedImages.length);
            // ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã®srcã‚’ä½¿ç”¨
            rewardImage.src = preloadedImages[randomIndex].src;
            rewardImage.style.display = "block";
            rewardImage.classList.add("show");
            rewardImage.classList.remove("hide");
            
            // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            setTimeout(() => {
              rewardImage.classList.remove("show");
              rewardImage.classList.add("hide");
              // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«éè¡¨ç¤º
              rewardImage.addEventListener("animationend", () => {
                rewardImage.style.display = "none";
                rewardImage.classList.remove("hide");
              }, { once: true });
            }, 1000);
          } else {
            document.getElementById("message").textContent =
              responseTime <= 2.0 ? `ã¯ã‚„ã„ï¼ã›ã„ã‹ã„ï¼+${points}ã¦ã‚“` : `ã›ã„ã‹ã„ï¼+${points}ã¦ã‚“`;
          }
          
          score += points;
          updateScoreDisplay();
          responseTimes.push({ note: correctNote, time: responseTime });
          attempts++;
          if (attempts >= maxAttempts) {
            endGame();
          } else {
            setTimeout(generateRandomNote, 1000);
          }
        } else {
          score += penalty;
          combo = 0;  // ã‚³ãƒ³ãƒœã‚’ãƒªã‚»ãƒƒãƒˆ
          updateScoreDisplay();
          mistakes++;
          // mistakeCount[selectedNote] = (mistakeCount[selectedNote] || 0) + 1;
          mistakeCount[correctNote] = (mistakeCount[correctNote] || 0) + 1;
          document.getElementById("message").textContent = `ã‚‚ã†ã„ã¡ã©ï¼${penalty}ã¦ã‚“`;
          setTimeout(() => {
            document.getElementById("message").textContent = "ã‚ã‹ã‚‹ã‹ãªï¼Ÿ";
          }, 1000);
        }
      } else {
        // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
        if (selectedNote === correctNote) {
          reviewCorrectCount++;
          document.getElementById("message").textContent = `æ­£è§£ï¼`;
          reviewIndex++;
        } else {
          document.getElementById("message").textContent = `ä¸æ­£è§£ï¼`;
        }
        // reviewIndex++;
        setTimeout(() => {
            document.getElementById("message").textContent = "ã‚ã‹ã‚‹ã‹ãªï¼Ÿ";
        }, 1000);
        setTimeout(generateRandomNote, 1000);
      }
    }

    function endGame() {
      let totalTime = responseTimes.reduce((sum, r) => sum + r.time, 0);
      let avgTime = totalTime / responseTimes.length || 0;
      responseTimes.sort((a, b) => a.time - b.time);
      let fastest = responseTimes.slice(0, 3);
      let slowest = responseTimes.slice(-3);
      let mistakesSorted = Object.entries(mistakeCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);



      let resultMessage = `
        <p>ğŸµ ã‚²ãƒ¼ãƒ çµ‚äº† ğŸµ</p>
        <p><strong>ã”ã†ã‘ã„:</strong> ${score}ã¦ã‚“</p>
        <p><strong>â—¯ã®éŸ³:</strong> ${responseTimes.length - mistakes}ã“ã€
           <strong>Ã—ã®éŸ³:</strong> ${mistakes}ã“</p>
        <p><strong>å¹³å‡ã®åå¿œæ™‚é–“:</strong> ${avgTime.toFixed(2)} ç§’</p>
        <p><strong>ã¯ã‚„ã‹ã£ãŸéŸ³ãƒˆãƒƒãƒ—3:</strong> </p><p>
          ${fastest.map(n => `${convertNoteToJapanese(n.note)}`).join("<br>")}
        </p>
        <p><strong>ãŠãã‹ã£ãŸéŸ³ãƒˆãƒƒãƒ—3:</strong> </p><p>
          ${slowest.map(n => `${convertNoteToJapanese(n.note)}`).join("<br>")}
        </p>
        <p><strong>ã¾ã¡ãŒãˆãŸéŸ³ãƒˆãƒƒãƒ—3:</strong> </p><p>
          ${mistakesSorted.map(m => `${convertNoteToJapanese(m[0])}(${m[1]}å›)`).join("<br>")}
        </p><br>
        <p style="color:#9333ea;"><strong>ãŠãã‹ã£ãŸéŸ³ã€ã¾ã¡ãŒãˆãŸéŸ³ã‚’<br>ãµãã—ã‚…ã†ã—ã‚ˆã†ï¼</strong>
        </p>
      `;
      document.getElementById("resultText").innerHTML = resultMessage;
      document.getElementById("restartButton").style.display = "none";
      document.getElementById("resultContainer").style.display = "block";
      // çµ‚äº†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
      document.getElementById("endGameButton").style.display = "none";
    }

    // ã€Œã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤ã€ãƒœã‚¿ãƒ³
    function restartGame() {
      document.getElementById("resultContainer").style.display = "none";
      document.getElementById("message").textContent = "";
      resetGame();
      generateRandomNote();
      // ã‚²ãƒ¼ãƒ å†é–‹ã—ãŸã‚‰ã€çµ‚äº†ãƒœã‚¿ãƒ³ã‚’å†åº¦è¡¨ç¤º
      document.getElementById("endGameButton").style.display = "inline-block";
    }

    // ã€Œçµ‚äº†ã€ãƒœã‚¿ãƒ³ (çµæœç”»é¢)
    function exitGame() {
      // ã‚²ãƒ¼ãƒ ã‚’å®Œå…¨ã«çµ‚äº†ã—ã€UIã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById("resultContainer").style.display = "none";
      document.getElementById("message").textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„";
      document.getElementById("staff").innerHTML = "";
      resetGame();
      // çµ‚äº†ã—ãŸã®ã§ã€çµ‚äº†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã€ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’å†è¡¨ç¤º
      document.getElementById("endGameButton").style.display = "none";
      document.getElementById("startButton").style.display = "inline-block";
    }

    // ç™½éµãƒ»é»’éµã®ã‚¯ãƒªãƒƒã‚¯ã‚„ã‚¿ãƒƒãƒã§éŸ³ã‚’é³´ã‚‰ã™
    document.querySelectorAll('.piano .key').forEach(key => {
      key.addEventListener('mousedown', () => {
        const note = key.dataset.note;
        playNote(note);
        checkAnswer(note);
      });
      key.addEventListener('touchstart', (event) => {
        event.preventDefault();
        const note = event.target.dataset.note;
        playNote(note);
        checkAnswer(note);
      });
    });

    async function demoMode() {
      // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ä»–ã®æ“ä½œã‚’ç„¡åŠ¹åŒ–
      document.getElementById("startButton").disabled = true;
      document.getElementById("endGameButton").disabled = true;

      // å‡ºé¡Œç¯„å›²ã®å¤‰æ•°ã‚’ä½¿ç”¨
      const demoNotes = generateNoteRange(noteRange.start, noteRange.end);
      
      // ç”Ÿæˆã•ã‚ŒãŸéŸ³ç¬¦ã‚’é †ç•ªã«è¡¨ç¤ºãƒ»å†ç”Ÿ
      for (let note of demoNotes) {
        // éŸ³ç¬¦ã‚’è¡¨ç¤º
        let letter = note.charAt(0);
        let octave = note.slice(1);
        drawStaff(letter + "/" + octave, true);

        // éµç›¤ã®ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã‚’æ›´æ–°
        updateKeyboardOctave(octave);

        // å¯¾å¿œã™ã‚‹éµç›¤ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        const key = document.querySelector(`.key[data-note="${note}"]`);
        if (key) {
          key.style.backgroundColor = '#e0e0e0';
        }

        // playNoteã®å®Œäº†ã‚’å¾…ã¤
        await playNote(note);

        // 0.2ç§’å¾…æ©Ÿ
        // await new Promise(resolve => setTimeout(resolve, 200));
        await new Promise(resolve => setTimeout(resolve, 100));

        // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å…ƒã«æˆ»ã™
        if (key) {
          key.style.backgroundColor = key.classList.contains('black') ? '#333' : 'white';
        }
      }

      // ãƒ‡ãƒ¢çµ‚äº†å¾Œã€ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
      document.getElementById("message").textContent = "";
      document.getElementById("startButton").disabled = false;
      document.getElementById("endGameButton").disabled = false;
    }

    // éµç›¤ã®ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateKeyboardOctave(octave) {
      const naturalKeys = ["C", "D", "E", "F", "G", "A", "B"];
      const sharpKeys = ["C#", "D#", "F#", "G#", "A#"];

      // ç™½éµæ›´æ–°
      const whiteKeys = document.querySelectorAll('.piano .key:not(.black)');
      whiteKeys.forEach((key, idx) => {
        let noteLetter = naturalKeys[idx];
        if (idx === 0) {
          key.dataset.note = "C" + octave;
          key.textContent = "C" + octave;
        } else {
          key.dataset.note = noteLetter + octave;
          key.textContent = "";
        }
      });

      // é»’éµæ›´æ–°
      const blackKeys = document.querySelectorAll('.piano .key.black');
      blackKeys.forEach((key, idx) => {
        key.dataset.note = sharpKeys[idx] + octave;
        key.textContent = "";
      });
    }

    function convertNoteToJapanese(note) {
      // éŸ³åã®å¤‰æ›ãƒ†ãƒ¼ãƒ–ãƒ«
      const noteNames = {
        'C': 'ãƒ‰',
        'D': 'ãƒ¬',
        'E': 'ãƒŸ',
        'F': 'ãƒ•ã‚¡',
        'G': 'ã‚½',
        'A': 'ãƒ©',
        'B': 'ã‚·'
      };

      // ã‚·ãƒ£ãƒ¼ãƒ—ã®å¤‰æ›ãƒ†ãƒ¼ãƒ–ãƒ«
      const sharpNames = {
        'C#': 'ãƒ‰ã®ã‚·ãƒ£ãƒ¼ãƒ—',
        'D#': 'ãƒ¬ã®ã‚·ãƒ£ãƒ¼ãƒ—',
        'F#': 'ãƒ•ã‚¡ã®ã‚·ãƒ£ãƒ¼ãƒ—',
        'G#': 'ã‚½ã®ã‚·ãƒ£ãƒ¼ãƒ—',
        'A#': 'ãƒ©ã®ã‚·ãƒ£ãƒ¼ãƒ—'
      };

      // ã‚·ãƒ£ãƒ¼ãƒ—ã®éŸ³ç¬¦ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
      if (note.includes('#')) {
        const noteName = note.slice(0, 2); // C#, D# ãªã©
        const octave = note.slice(-1);     // æœ€å¾Œã®æ–‡å­—ãŒã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ç•ªå·
        return `${sharpNames[noteName]}ï¼ˆ${octave}ã¤ã‚ï¼‰`;
      } else {
        const noteName = note.charAt(0);   // C, D ãªã©
        const octave = note.slice(-1);     // æœ€å¾Œã®æ–‡å­—ãŒã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ç•ªå·
        return `${noteNames[noteName]}ï¼ˆ${octave}ã¤ã‚ï¼‰`;
      }
    }

    // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateScoreDisplay() {
      document.getElementById("scoreDisplay").textContent = `${combo}ã‚³ãƒ³ãƒœã€€${score}ã¦ã‚“`;
    }
  </script>
  <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ -->
  <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  <script>
    var vConsole = new VConsole();
  </script>
</body>

</html>
