<!-- ãƒˆéŸ³è¨˜å·ã®ã¿ã€€ -->
<!-- ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–è¿½åŠ ã€€ -->
<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
  <!-- Google Fonts ã‚’è¿½åŠ  -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/vexflow/1.2.93/vexflow-min.js"></script> -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vexflow/3.0.9/vexflow-min.js"></script>

  <style>
    /* å…¨ä½“ã‚³ãƒ³ãƒ†ãƒŠã®è¨­å®š */
    .container {
      width: 350px;
      height: 640px;
      margin: 0 auto;
      overflow: hidden;
      position: relative;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚„ãƒœã‚¿ãƒ³ãªã©ã¯ãã®ã¾ã¾ã§ã‚‚ã‚ˆã„ãŒã€å¿…è¦ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚„ãƒãƒ¼ã‚¸ãƒ³ã‚‚èª¿æ•´ */
    .staff-container #staff {
      width: 300px;
      /* 360px ã«åã¾ã‚‹ã‚ˆã†ã«ä½™ç™½ã‚’ã¨ã‚‹ */
      height: 180px;
      margin: 0 auto;
    }

    /* ãƒªã‚»ãƒƒãƒˆã¨åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      color: #333;
      text-align: center;
      padding: 10px 0 0 0;
    }

    h2 {
      margin-bottom: 20px;
      font-weight: 700;
    }

    button {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 5px;
      background-color: #007BFF;
      color: white;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
    }

    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }

    button:hover:not(:disabled) {
      background-color: #0056b3;
      transform: translateY(-2px);
    }

    /* ãƒ”ã‚¢ãƒã‚¹ã‚¿ã‚¤ãƒ« */
    .piano {
      position: relative;
      width: 300px;
      height: 120px;
      margin: 10px auto;
    }

    /* ç™½éµ */
    .piano .key:not(.black) {
      width: 40px;
      height: 120px;
      border: 1px solid #999;
      background-color: white;
      border-radius: 4px;
      float: left;
      position: relative;
      line-height: 120px;
      font-size: 1em;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s, box-shadow 0.2s;
      z-index: 1;
    }

    /* é»’éµ */
    .piano .key.black {
      width: 28px;
      height: 80px;
      background-color: #333;
      border: 1px solid #444;
      border-radius: 4px;
      position: absolute;
      top: 0;
      z-index: 2;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s, box-shadow 0.2s;
    }

    /* é»’éµã®é…ç½®ï¼šHTMLæœ«å°¾ã«ã¾ã¨ã‚ã¦ã‚ã‚‹å ´åˆã¯ã€Œ8ç•ªç›®ã€œ12ç•ªç›®ã€ãŒé»’éµ */
    .piano .key:nth-child(8) {
      /* 1ç•ªç›®ã®é»’éµ (C#) */
      left: 28px;
    }

    .piano .key:nth-child(9) {
      /* 2ç•ªç›®ã®é»’éµ (D#) */
      left: 68px;
    }

    .piano .key:nth-child(10) {
      /* 3ç•ªç›®ã®é»’éµ (F#) */
      left: 148px;
    }

    .piano .key:nth-child(11) {
      /* 4ç•ªç›®ã®é»’éµ (G#) */
      left: 188px;
    }

    .piano .key:nth-child(12) {
      /* 5ç•ªç›®ã®é»’éµ (A#) */
      left: 228px;
    }

    /* ã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .piano .key:active {
      background-color: #e0e0e0;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
    }

    .piano .key.black:active {
      background-color: #555;
    }

    /* æ¥½è­œè¡¨ç¤ºé ˜åŸŸ */
    .staff-container #staff {
      display: flex;
      justify-content: center;
      width: 300px;
      height: 180px;
      margin: 0 auto;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .message {
      font-size: 1.5em;
      margin: 20px;
    }

    /* çµ±è¨ˆæƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .result-container {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      text-align: center;
      width: 90%;
      max-width: 320px;
      z-index: 100;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translate(-50%, -60%);
      }

      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }

    /* å ±é…¬ç”»åƒ */
    .reward-image {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 300px;
      height: 300px;
      border-radius: 50%;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>éŸ³ç¬¦å½“ã¦ã‚²ãƒ¼ãƒ </h2>

    <!-- 1ã¤ã®ãƒœã‚¿ãƒ³ã§ã‚¹ã‚¿ãƒ¼ãƒˆï¼†éŸ³ã‚’æœ‰åŠ¹åŒ– -->
    <button id="startButton">ã‚²ãƒ¼ãƒ é–‹å§‹</button>

    <!-- ã‚²ãƒ¼ãƒ ã‚’é€”ä¸­çµ‚äº†ã§ãã‚‹ãƒœã‚¿ãƒ³ã€‚æœ€åˆã¯éè¡¨ç¤º -->
    <button id="endGameButton" style="display:none;">ã‚²ãƒ¼ãƒ çµ‚äº†</button>

    <!-- çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ã‚¨ãƒªã‚¢ -->
    <div id="resultContainer" class="result-container">
      <div class="result-content">
        <p id="resultText"></p>
        <!-- ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹ãƒœã‚¿ãƒ³ -->
        <button onclick="restartGame()">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
        <!-- å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  -->
        <button id="reviewButton" onclick="startReviewMode()">å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
        <!-- ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã™ã‚‹ãƒœã‚¿ãƒ³ -->
        <button onclick="exitGame()">çµ‚äº†</button>
      </div>
    </div>

    <div class="staff-container">
      <div id="staff"></div>
    </div>
    <div class="message" id="message">ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­</div>
    <img id="rewardImage" class="reward-image" src="https://via.placeholder.com/300" alt="Reward">

    <!-- ç™½éµ7ã¤ã€é»’éµ5ã¤ã‚’ã¾ã¨ã‚ã¦æœ€å¾Œã« -->
    <div class="piano">
      <!-- ç™½éµ (1ã€œ7ç•ªç›®) -->
      <div class="key" data-note="C4">C4</div>
      <div class="key" data-note="D4"></div>
      <div class="key" data-note="E4"></div>
      <div class="key" data-note="F4"></div>
      <div class="key" data-note="G4"></div>
      <div class="key" data-note="A4"></div>
      <div class="key" data-note="B4"></div>
      <!-- é»’éµ (8ã€œ12ç•ªç›®) -->
      <div class="key black" data-note="C#4"></div>
      <div class="key black" data-note="D#4"></div>
      <div class="key black" data-note="F#4"></div>
      <div class="key black" data-note="G#4"></div>
      <div class="key black" data-note="A#4"></div>
    </div>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¹ã‚¿ãƒƒãƒ•ç”Ÿæˆå‰ã« DEFAULT_LINE_SPACING ã‚’è¨­å®š
    Vex.Flow.Stave.DEFAULT_LINE_SPACING = 20;

    // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let reviewMode = false;
    let reviewQuestions = []; // å‡ºé¡Œã™ã‚‹ãƒãƒ¼ãƒˆï¼ˆä¾‹ï¼š"C4"ï¼‰
    let reviewIndex = 0;
    let reviewCorrectCount = 0;
    // å¾©ç¿’å‡ºé¡Œæ•°ï¼ˆã‚ã¨ã‹ã‚‰å¤‰æ›´å¯èƒ½ï¼‰
    const maxReviewQuestions = 3;

    let synth;
    let correctNote;
    let attempts = 0;
    let mistakes = 0;
    let score = 0;
    let responseTimes = [];
    let mistakeCount = {};
    let startTime;
    const maxAttempts = 10;
    const baseScore = 10;
    const fastBonus = 20;
    const penalty = -10;

    // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰éŸ³æœ‰åŠ¹åŒ–ï¼‹ã‚²ãƒ¼ãƒ é–‹å§‹
    document.getElementById("startButton").addEventListener("click", async () => {
      await Tone.start(); // AudioContextã‚’æœ‰åŠ¹åŒ–
      alert("éŸ³ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼");

      resetGame();
      synth = new Tone.Synth().toDestination();
      document.getElementById("message").textContent = "ã‚²ãƒ¼ãƒ é–‹å§‹ï¼éŸ³ç¬¦ã‚’å½“ã¦ã¦ãã ã•ã„";
      generateRandomNote();

      // ã‚²ãƒ¼ãƒ é–‹å§‹ã—ãŸã‚‰ã€ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’éš ã—ã€çµ‚äº†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      document.getElementById("startButton").style.display = "none";
      document.getElementById("endGameButton").style.display = "inline-block";
    });

    // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é€”ä¸­çµ‚äº†
    document.getElementById("endGameButton").addEventListener("click", () => {
      endGame(); // é€”ä¸­çµ‚äº†ã§ã‚‚çµæœã‚’è¡¨ç¤º
    });

    function resetGame() {
      attempts = 0;
      mistakes = 0;
      score = 0;
      responseTimes = [];
      mistakeCount = {};
      document.getElementById("rewardImage").style.display = "none";
    }

    async function playNote(note) {
      if (Tone.context.state !== "running") {
        await Tone.start();
      }
      if (!synth) return;
      try {
        synth.triggerAttackRelease(note, "8n");
      } catch (error) {
        console.error("Error playing note:", error);
      }
      checkAnswer(note);
    }

    // drawStaff: å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€å•é¡Œã®éŸ³ç¬¦ã¨ä½µã›ã¦å¸¸ã« C/4 ã¨ C/5 ã‚’é’è‰²ã§è¡¨ç¤º
    function drawStaff(note) {
      const staffDiv = document.getElementById("staff");
      staffDiv.innerHTML = "";
      const renderer = new Vex.Flow.Renderer(staffDiv, Vex.Flow.Renderer.Backends.SVG);
      renderer.resize(300, 200);
      const context = renderer.getContext();
      // ã“ã“ã§SVGå…¨ä½“ã‚’1.3å€ã«ã‚¹ã‚±ãƒ¼ãƒ«ã™ã‚‹ ^^^
      context.svg.style.transform = "scale(1.3, 1.3)";
      context.svg.style.transformOrigin = "0 0";

      // ãƒˆéŸ³è¨˜å·ã®ã¿ã€€
      // ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–è¿½åŠ ã€€
      // const stave = new Vex.Flow.Stave(25, 40, 250);
      const stave = new Vex.Flow.Stave(25, 40, 190);
      stave.addClef("treble").setContext(context).draw();

      if (!reviewMode) {
        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šå•é¡Œã®éŸ³ç¬¦ã®ã¿æç”»
        const staveNote = new Vex.Flow.StaveNote({
          keys: [note],
          duration: "q",
          clef: "treble"
        });
        // ãƒãƒ¼ãƒˆã® stem ã‚’æ¶ˆã™
        staveNote.setStemStyle({ strokeStyle: "transparent" });
        const voice = new Vex.Flow.Voice({ num_beats: 1, beat_value: 4 });
        voice.addTickables([staveNote]);
        new Vex.Flow.Formatter().joinVoices([voice]).format([voice], 400);
        voice.draw(context, stave);
      } else {
        // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼š1æ‹å†…ã«1ã¤ã®å’ŒéŸ³ã¨ã—ã¦ã€å·¦å´ã«å¸¸ã«é’è‰²ã®å‚è€ƒéŸ³ï¼ˆC/4 ã¨ C/5ï¼‰ã€
        // å³å´ã«å•é¡Œã®éŸ³ç¬¦ã‚’è¡¨ç¤ºã™ã‚‹
        // ã‚­ãƒ¼é…åˆ—ï¼šæœ€åˆ2ã¤ãŒå‚è€ƒéŸ³ã€3ã¤ç›®ãŒå•é¡Œã®éŸ³
        // è‡ªåˆ†ã§æ›¸ã„ã¦ã¿ã‚‹
        
        //ã€€ãƒ‰ã®éŸ³ï¼’ã¤
        const chordKeys = ["c/4", "c/5","c/6"];
        const staveNote = new Vex.Flow.StaveNote({
          keys: chordKeys,
          duration: "q",  
          clef: "treble"
        });
        // ãƒãƒ¼ãƒˆã® stem ã‚’æ¶ˆã™
        staveNote.setStemStyle({ strokeStyle: "transparent" });

        // staveNote.setKeyStyle( 0,{ fillStyle: "blue", strokeStyle: "blue" });
        // staveNote.setKeyStyle( 1,{ fillStyle: "blue", strokeStyle: "blue" });
        [0, 1,2].forEach(i => staveNote.setKeyStyle(i, { fillStyle: "blue", strokeStyle: "blue" }));


        const voice = new Vex.Flow.Voice({ num_beats: 1, beat_value: 4 });
        voice.addTickables([staveNote]);
        new Vex.Flow.Formatter().joinVoices([voice]).format([voice], 400);  
        voice.draw(context, stave);

        //ã€€å•é¡Œã®éŸ³
        // chordKeys = [note];
        staveNote2 = new Vex.Flow.StaveNote({
          keys: [note],
          duration: "q",
          clef: "treble"
        });
        // ãƒãƒ¼ãƒˆã® stem ã‚’æ¶ˆã™
        staveNote2.setStemStyle({ strokeStyle: "transparent" });
        const voice2 = new Vex.Flow.Voice({ num_beats: 1, beat_value: 4 });
        voice2.addTickables([staveNote2]);
        new Vex.Flow.Formatter().joinVoices([voice2]).format([voice2], 400);
        voice2.draw(context, stave);
        console.log("context ",context)
        console.log("stave ",stave)
        // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€æ¡ç‚¹ã¯è¡Œã‚ãšæ­£è§£æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹å‡¦ç†ã¯ checkAnswer() å´ã§å¯¾å¿œ
      }
      document.getElementById("message").textContent = `ã‚ã‹ã‚‹ã‹ãªï¼Ÿ`;
    }

    function generateRandomNote() {
      if (!reviewMode) {
        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šC4ï½B5ã®ç¯„å›²ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œ
        const notes = ["C4", "D4", "E4", "F4", "G4", "A4", "B4",
          "C5", "D5", "E5", "F5", "G5", "A5", "B5"];
        let index = Math.floor(Math.random() * notes.length);
        correctNote = notes[index];
      } else {
        // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼šreviewQuestions é…åˆ—ã‹ã‚‰å‡ºé¡Œ
        if (reviewIndex < reviewQuestions.length) {
          correctNote = reviewQuestions[reviewIndex];
        } else {
          finishReviewMode();
          return;
        }
      }
      // å½¢å¼å¤‰æ›: "C4" -> "C/4"
      let letter = correctNote.charAt(0);
      let octave = correctNote.slice(1);
      let vexflowNote = letter + "/" + octave;

      // éµç›¤ã®ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã¯ã€ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œã®å ´åˆã€
      // ã‚‚ã—ãƒ©ãƒ³ãƒ€ãƒ éŸ³ãŒC4ï½B4ãªã‚‰ "4"ã€C5ï½B5ãªã‚‰ "5" ã«å›ºå®š
      let keyboardOctave = (parseInt(octave) < 5) ? "4" : "5";

      // æ›´æ–°ï¼šéµç›¤ã®éŸ³ã‚’è¡¨ç¤ºã™ã‚‹ï¼ˆéµç›¤ã¯ãƒ‰ã‹ã‚‰ã‚·ï¼‹é»’éµã‚‚å«ã‚€ï¼‰
      // 1ã€œ7ç•ªç›®ãŒç™½éµ, 8ã€œ12ç•ªç›®ãŒé»’éµ
      const naturalKeys = ["C", "D", "E", "F", "G", "A", "B"];
      const sharpKeys = ["C#", "D#", "F#", "G#", "A#"];

      // ç™½éµæ›´æ–°ï¼ˆ1ã€œ7ç•ªç›®ï¼‰
      const whiteKeys = document.querySelectorAll('.piano .key:not(.black)');
      whiteKeys.forEach((key, idx) => {
        let noteLetter = naturalKeys[idx];
        if (idx === 0) {
          // å·¦ç«¯ã®ç™½éµã¯å¸¸ã«ãƒ‰ï¼ˆCï¼‰
          key.dataset.note = "C" + keyboardOctave;
          key.textContent = "C" + keyboardOctave;
        } else {
          key.dataset.note = noteLetter + keyboardOctave;
          key.textContent = "";
        }
      });

      // é»’éµæ›´æ–°ï¼ˆ8ã€œ12ç•ªç›®ï¼‰
      const blackKeys = document.querySelectorAll('.piano .key.black');
      blackKeys.forEach((key, idx) => {
        key.dataset.note = sharpKeys[idx] + keyboardOctave;
        key.textContent = ""; // é»’éµã¯æ–‡å­—ã‚’è¡¨ç¤ºã—ãªã„
      });

      drawStaff(letter + "/" + octave);
      startTime = Date.now();
    }

    // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼šçµæœç”»é¢ã®ã€Œå¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã§å‘¼ã³å‡ºã™
    function startReviewMode() {
      // ã“ã“ã§ã¯ã€å‰å›ã®ã‚²ãƒ¼ãƒ çµæœã‹ã‚‰ã€Œé–“é•ã„ã®å¤šã‹ã£ãŸéŸ³ãƒˆãƒƒãƒ—3ã€ã¨ã€Œåå¿œãŒé…ã‹ã£ãŸéŸ³ãƒˆãƒƒãƒ—3ã€ã‚’
      // ä»®ã«ãã‚Œãã‚Œ reviewPool1, reviewPool2 ã¨ã—ã¦ä½œæˆã™ã‚‹ä¾‹ã§ã™ã€‚
      // â€»å®Ÿéš›ã¯ endGame() æ™‚ã«è¨ˆç®—ã—ãŸçµæœã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ã™ã‚‹ã‹ã€å†è¨ˆç®—ã—ã¦ãã ã•ã„ã€‚
      let reviewPoolSet = new Set();
      // ã“ã“ã§ã¯ã€mistakeCount ã‹ã‚‰ãƒˆãƒƒãƒ—3ã®éŸ³ã¨ã€responseTimes ã®é…ã„ä¸Šä½3ã‚’ãƒ—ãƒ¼ãƒ«ã¨ã™ã‚‹ä¾‹
      // æ³¨æ„ï¼šresponseTimes ã®ã‚½ãƒ¼ãƒˆçµæœã¯ endGame() å†…ã§ã®ã¿åˆ©ç”¨ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯å˜ç´”ãªä¾‹ã§ã™ã€‚
      // å®Ÿéš›ã«ã¯é©åˆ‡ãªãƒ­ã‚¸ãƒƒã‚¯ã«ã‚ˆã‚Šãƒˆãƒƒãƒ—3ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
      Object.keys(mistakeCount).forEach(note => reviewPoolSet.add(note));
      responseTimes.forEach(rtObj => reviewPoolSet.add(rtObj.note));
      reviewQuestions = Array.from(reviewPoolSet);
      // ã‚‚ã—ãƒ—ãƒ¼ãƒ«ãŒ maxReviewQuestions ã‚ˆã‚Šå¤šã‘ã‚Œã°ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦é¸æŠ
      if (reviewQuestions.length > maxReviewQuestions) {
        reviewQuestions = shuffleArray(reviewQuestions).slice(0, maxReviewQuestions);
      }
      reviewMode = true;
      reviewIndex = 0;
      reviewCorrectCount = 0;
      // çµæœãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
      document.getElementById("resultContainer").style.display = "none";
      console.log("starReviewMode & genelateRandomnNote")
      generateRandomNote();
    }

    // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰çµ‚äº†ï¼šå¾©ç¿’çµæœã‚’è¡¨ç¤º
    function finishReviewMode() {
      reviewMode = false;
      let reviewResultMessage = `
        <p>å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ çµ‚äº†</p>
        <p>æ­£è§£æ•°ï¼š${reviewCorrectCount} / ${maxReviewQuestions}</p>
      `;
      document.getElementById("resultText").innerHTML = reviewResultMessage;
      document.getElementById("resultContainer").style.display = "block";
    }

    // å˜ç´”ãªã‚·ãƒ£ãƒƒãƒ•ãƒ«é–¢æ•°
    function shuffleArray(array) {
      let arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function checkAnswer(selectedNote) {
      let responseTime = (Date.now() - startTime) / 1000;
      if (!reviewMode) {
        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
        if (selectedNote === correctNote) {
          let points = responseTime <= 2.0 ? fastBonus : baseScore;
          document.getElementById("message").textContent =
            responseTime <= 2.0 ? `ã¯ã‚„ã„ï¼ã›ã„ã‹ã„ï¼+${points}ã¦ã‚“` : `ã›ã„ã‹ã„ï¼+${points}ã¦ã‚“`;
          score += points;
          responseTimes.push({ note: correctNote, time: responseTime });
          attempts++;
          if (attempts >= maxAttempts) {
            endGame();
          } else {
            setTimeout(generateRandomNote, 1000);
          }
        } else {
          score += penalty;
          mistakes++;
          mistakeCount[selectedNote] = (mistakeCount[selectedNote] || 0) + 1;
          document.getElementById("message").textContent = `ã‚‚ã†ã„ã¡ã©ï¼${penalty}ã¦ã‚“`;
        }
      } else {
        // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
        if (selectedNote === correctNote) {
          reviewCorrectCount++;
          document.getElementById("message").textContent = `æ­£è§£ï¼`;
        } else {
          document.getElementById("message").textContent = `ä¸æ­£è§£ï¼`;
        }
        reviewIndex++;
        setTimeout(generateRandomNote, 1000);
      }
    }

    function endGame() {
      let totalTime = responseTimes.reduce((sum, r) => sum + r.time, 0);
      let avgTime = totalTime / responseTimes.length || 0;
      responseTimes.sort((a, b) => a.time - b.time);
      let fastest = responseTimes.slice(0, 3);
      let slowest = responseTimes.slice(-3);
      let mistakesSorted = Object.entries(mistakeCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);

      let resultMessage = `
        <p>ğŸµ ã‚²ãƒ¼ãƒ çµ‚äº† ğŸµ</p>
        <p><strong>åˆè¨ˆå¾—ç‚¹:</strong> ${score}</p>
        <p><strong>ã‹ã‹ã£ãŸæ™‚é–“:</strong> ${totalTime.toFixed(2)} ç§’</p>
        <p><strong>æ­£è§£ã®æ•°:</strong> ${responseTimes.length}</p>
        <p><strong>é–“é•ãˆãŸæ•°:</strong> ${mistakes}</p>
        <p><strong>å¹³å‡ã®åå¿œæ™‚é–“:</strong> ${avgTime.toFixed(2)} ç§’</p>
        <p><strong>åå¿œãŒæ—©ã‹ã£ãŸéŸ³ãƒˆãƒƒãƒ—3:</strong> 
          ${fastest.map(n => `${n.note}(${n.time.toFixed(2)}ç§’)`).join(", ")}
        </p>
        <p><strong>åå¿œãŒé…ã‹ã£ãŸéŸ³ãƒˆãƒƒãƒ—3:</strong> 
          ${slowest.map(n => `${n.note}(${n.time.toFixed(2)}ç§’)`).join(", ")}
        </p>
        <p><strong>é–“é•ã„ã®å¤šã‹ã£ãŸéŸ³ãƒˆãƒƒãƒ—3:</strong> 
          ${mistakesSorted.map(m => `${m[0]}(${m[1]}å›)`).join(", ")}
        </p>
      `;
      document.getElementById("resultText").innerHTML = resultMessage;
      document.getElementById("resultContainer").style.display = "block";
      // çµ‚äº†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
      document.getElementById("endGameButton").style.display = "none";
    }

    // ã€Œã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤ã€ãƒœã‚¿ãƒ³
    function restartGame() {
      document.getElementById("resultContainer").style.display = "none";
      document.getElementById("message").textContent = "";
      resetGame();
      generateRandomNote();
      // ã‚²ãƒ¼ãƒ å†é–‹ã—ãŸã‚‰ã€çµ‚äº†ãƒœã‚¿ãƒ³ã‚’å†åº¦è¡¨ç¤º
      document.getElementById("endGameButton").style.display = "inline-block";
    }

    // ã€Œçµ‚äº†ã€ãƒœã‚¿ãƒ³ (çµæœç”»é¢)
    function exitGame() {
      // ã‚²ãƒ¼ãƒ ã‚’å®Œå…¨ã«çµ‚äº†ã—ã€UIã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById("resultContainer").style.display = "none";
      document.getElementById("message").textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„";
      document.getElementById("staff").innerHTML = "";
      resetGame();
      // çµ‚äº†ã—ãŸã®ã§ã€çµ‚äº†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã€ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’å†è¡¨ç¤º
      document.getElementById("endGameButton").style.display = "none";
      document.getElementById("startButton").style.display = "inline-block";
    }

    // ç™½éµãƒ»é»’éµã®ã‚¯ãƒªãƒƒã‚¯ã‚„ã‚¿ãƒƒãƒã§éŸ³ã‚’é³´ã‚‰ã™
    document.querySelectorAll('.piano .key').forEach(key => {
      key.addEventListener('mousedown', () => {
        const note = key.dataset.note;
        playNote(note);
      });
      key.addEventListener('touchstart', (event) => {
        event.preventDefault();
        const note = event.target.dataset.note;
        playNote(note);
      });
    });
  </script>
  <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ -->
  <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  <script>
    var vConsole = new VConsole();
  </script>
</body>

</html>
