<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éà„É¨„Éº„Éã„É≥„Ç∞</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vexflow/1.2.93/vexflow-min.js"></script>
    <style>
        .piano {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .key {
            width: 40px;
            height: 120px;
            border: 1px solid #000;
            display: inline-block;
            background-color: white;
            text-align: center;
            line-height: 120px;
            font-size: 18px;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
        }
        .key.black {
            width: 30px;
            height: 80px;
            background-color: black;
            color: white;
            margin-left: -15px;
            margin-right: -15px;
            position: relative;
            z-index: 1;
        }
        .key:active {
            background-color: #ddd;
        }
        .staff-container {
            display: flex;
            justify-content: center;
            margin: 20px;
            background-color: blue;
        }
        .message {
            text-align: center;
            font-size: 1.5em;
            margin: 20px;
        }
        #staff {
            width: 300px;
            height: 200px;
            background-color: gray;
            justify-content: center;
        }
        .reward-image {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
        }
    </style>
</head>
<body>
    
    <h2>Èü≥Á¨¶ÂΩì„Å¶</h2>
    <button id="startGameButton">„Çπ„Çø„Éº„Éà</button>
    <button id="startAudioButton" disabled>Èü≥„ÇíÊúâÂäπÂåñ</button>
    <div class="staff-container">
        <div id="staff"></div>
    </div>
    <div class="message" id="message">„Çπ„Çø„Éº„Éà„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
    
    <img id="rewardImage" class="reward-image" src="https://via.placeholder.com/300" alt="Reward">
    
    <div class="piano">
        <div class="key" data-note="C4">C</div> 
        <div class="key black" data-note="C#4">C#</div>
        <div class="key" data-note="D4">D</div>
        <div class="key black" data-note="D#4">D#</div>
        <div class="key" data-note="E4">E</div>
        <div class="key" data-note="F4">F</div>
        <div class="key black" data-note="F#4">F#</div>
        <div class="key" data-note="G4">G</div>
        <div class="key black" data-note="G#4">G#</div>
        <div class="key" data-note="A4">A</div>
        <div class="key black" data-note="A#4">A#</div>
        <div class="key" data-note="B4">B</div>
        <div class="key" data-note="C5">C5</div>
    </div>
    
    <script>
        let synth;
        let correctNote;
        let attempts = 0;
        let mistakes = 0;
        let consecutiveCorrect = 0;
        let score = 0;
        let responseTimes = [];
        let mistakeCount = {};
        let startTime;
        const maxAttempts = 10;
        const baseScore = 10;
        const fastBonus = 20;
        const penalty = -10;

        document.getElementById("startGameButton").addEventListener("click", () => {
            resetGame();
            document.getElementById("message").textContent = "Èü≥„ÇíÊúâÂäπÂåñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
            document.getElementById("startAudioButton").disabled = false;
        });

        function resetGame() {
            attempts = 0;
            mistakes = 0;
            score = 0;
            responseTimes = [];
            mistakeCount = {};
            consecutiveCorrect = 0;
            document.getElementById("rewardImage").style.display = "none";
        }

        document.getElementById("startAudioButton").addEventListener("click", async () => {
            await Tone.start();
            alert("Èü≥„ÅåÊúâÂäπ„Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ");
            synth = new Tone.Synth().toDestination();
            document.getElementById("message").textContent = "„Ç≤„Éº„É†ÈñãÂßãÔºÅÈü≥Á¨¶„ÇíÂΩì„Å¶„Å¶„Åè„Å†„Åï„ÅÑ";
            generateRandomNote();
        });

        function playNote(note) {
            if (!synth) return;
            synth.triggerAttackRelease(note, "8n");
            checkAnswer(note); // Èü≥„ÇíÈ≥¥„Çâ„Åó„Å¶„Åã„ÇâÊ≠£Ë™§Âà§ÂÆöÔºÅ
            console.log("„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„É≥„Çµ„ÉºÂÆüË°å")
        }

        function drawStaff(note) {
            const staffDiv = document.getElementById("staff");
            staffDiv.innerHTML = "";
            const renderer = new Vex.Flow.Renderer(staffDiv, Vex.Flow.Renderer.Backends.SVG);
            renderer.resize(300, 200);
            const context = renderer.getContext();
            const stave = new Vex.Flow.Stave(25, 40, 250);
            stave.addClef("treble").setContext(context).draw();
            const staveNote = new Vex.Flow.StaveNote({
                keys: [note],
                duration: "q",
                clef: "treble"
            });
            const voice = new Vex.Flow.Voice({ num_beats: 1, beat_value: 4 });
            voice.addTickables([staveNote]);
            new Vex.Flow.Formatter().joinVoices([voice]).format([voice], 400);
            voice.draw(context, stave);
        }

        function generateRandomNote() {
            const notes = ["C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5"];
            let index = Math.floor(Math.random() * notes.length);
            correctNote = notes[index];
            // VexFlow „ÅÆÂΩ¢Âºè„Å´Â§âÊèõÔºàC4 ‚Üí C/4Ôºâ
            let vexflowNote = correctNote.charAt(0) + "/" + correctNote.charAt(1);
            console.log("Generated note:", correctNote, "VexFlow note:", vexflowNote);
            drawStaff(vexflowNote);
            // playNote(correctNote);
            startTime = Date.now();
        }

        function checkAnswer(selectedNote) {
            let responseTime = (Date.now() - startTime) / 1000;
            if (selectedNote === correctNote) {
//                let points = responseTime <= 2.0 ? fastBonus : baseScore;

                let points;
                if (responseTime <= 2.0) {
                    points = fastBonus; // 2Áßí‰ª•ÂÜÖ„Å™„Çâ„Éú„Éº„Éä„ÇπÁÇπ„ÇíÈÅ©Áî®
                    document.getElementById("message").textContent = `„ÅØ„ÇÑ„ÅÑÔºÅ„Åõ„ÅÑ„Åã„ÅÑÔºÅ+${points}„Å¶„Çì`;
                } else {
                    points = baseScore; // 2Áßí‰ª•‰∏ä„Å™„ÇâÈÄöÂ∏∏„ÅÆÁÇπÊï∞
                    document.getElementById("message").textContent = `„Åõ„ÅÑ„Åã„ÅÑÔºÅ+${points}„Å¶„Çì`;
                }
                console.log("responseTime " , responseTime)
                score += points;
                responseTimes.push({ note: correctNote, time: responseTime });
                //document.getElementById("message").textContent = `„Åõ„ÅÑ„Åã„ÅÑÔºÅ+${points}„Å¶„Çì`;
                attempts++;
                if (attempts >= maxAttempts) {
                    endGame();„ÄÄ
                }else {
                    setTimeout(generateRandomNote, 1000);
                    console.log('settimeout ÂÆüË°å');
                }
                
            } else {
                score += penalty;
                mistakes++;
                mistakeCount[selectedNote] = (mistakeCount[selectedNote] || 0) + 1;
                document.getElementById("message").textContent = `„ÇÇ„ÅÜ„ÅÑ„Å°„Å©ÔºÅ${penalty}„Å¶„Çì`;
            }
            // attempts++;
            // if (attempts >= maxAttempts) endGame();
            // else etTimeosut(generateRandomNote, 1000);
        }

        function endGame() {
    let totalTime = responseTimes.reduce((sum, r) => sum + r.time, 0);
    let avgTime = totalTime / responseTimes.length || 0;

    responseTimes.sort((a, b) => a.time - b.time);
    let fastest = responseTimes.slice(0, 3);
    let slowest = responseTimes.slice(-3);

    let mistakesSorted = Object.entries(mistakeCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);

    let resultMessage = `
        üéµ „Ç≤„Éº„É†ÁµÇ‰∫Ü üéµ
        - ÂêàË®àÂæóÁÇπ: ${score}
        - „Åã„Åã„Å£„ÅüÊôÇÈñì: ${totalTime.toFixed(2)} Áßí
        - Ê≠£Ëß£„ÅÆÊï∞: ${responseTimes.length}
        - ÈñìÈÅï„Åà„ÅüÊï∞: ${mistakes}
        - Âπ≥Âùá„ÅÆÂèçÂøúÊôÇÈñì: ${avgTime.toFixed(2)} Áßí
        - ÂèçÂøú„ÅåÊó©„Åã„Å£„ÅüÈü≥„Éà„ÉÉ„Éó3: ${fastest.map(n => `${n.note}(${n.time.toFixed(2)}Áßí)`).join(", ")}
        - ÂèçÂøú„ÅåÈÅÖ„Åã„Å£„ÅüÈü≥„Éà„ÉÉ„Éó3: ${slowest.map(n => `${n.note}(${n.time.toFixed(2)}Áßí)`).join(", ")}
        - ÈñìÈÅï„ÅÑ„ÅÆÂ§ö„Åã„Å£„ÅüÈü≥„Éà„ÉÉ„Éó3: ${mistakesSorted.map(m => `${m[0]}(${m[1]}Âõû)`).join(", ")}
    `;

    alert(resultMessage);
}


        document.querySelectorAll('.key').forEach(key => {
            key.addEventListener('mousedown', () => {
                const note = key.dataset.note;
                playNote(note);
            });
            key.addEventListener('touchstart', (event) => {
                event.preventDefault();
                const note = event.target.dataset.note;
                console.log('const note by touch' , note)
                playNote(note);
                console.log('playnote by touch',  note)
            });
        });
    </script>

    <!-- „Éá„Éê„ÉÉ„Ç∞Áî® -->
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
      var vConsole = new VConsole();
      console.log('Hello console!');
    </script>   
</body>
</html>
