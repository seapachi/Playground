<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vexflow/1.2.93/vexflow-min.js"></script>
    <style>
        .piano {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .key {
            width: 40px;
            height: 120px;
            border: 1px solid #000;
            display: inline-block;
            background-color: white;
            text-align: center;
            line-height: 120px;
            font-size: 18px;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
        }
        .key.black {
            width: 30px;
            height: 80px;
            background-color: black;
            color: white;
            margin-left: -15px;
            margin-right: -15px;
            position: relative;
            z-index: 1;
        }
        .key:active {
            background-color: #ddd;
        }
        .staff-container {
            display: flex;
            justify-content: center;
            margin: 20px;
            /* background-color: blue; */
        }
        .message {
            text-align: center;
            font-size: 1.5em;
            margin: 20px;
        }
        #staff {
            width: 300px;
            height: 200px;
            /* background-color: gray; */
            justify-content: center;
        }
        .reward-image {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
        }
        /* çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ« */
        .result-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 80%;
            max-width: 400px;
            z-index: 10;  /* é»’éµã‚ˆã‚Šå‰é¢ã« */
        }

        .result-content {
            font-size: 1.2em;
        }

        .result-container button {
            margin-top: 10px;
            padding: 10px;
            border: none;
            background: #007BFF;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        .result-container button:hover {
            background: #0056b3;
        }

    </style>
</head>
<body>
    
    <h2>éŸ³ç¬¦å½“ã¦</h2>
    <button id="startGameButton">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    <button id="startAudioButton" disabled>éŸ³ã‚’æœ‰åŠ¹åŒ–</button>
    <!-- çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ã‚¨ãƒªã‚¢ã‚’è¿½åŠ  -->
    <div id="resultContainer" class="result-container" style="display: none;">
        <div class="result-content">
            <!-- <h2>ğŸµ ã‚²ãƒ¼ãƒ çµ‚äº† ğŸµ</h2> -->
            <p id="resultText"></p>
            <button onclick="restartGame()">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
        </div>
    </div>

    <div class="staff-container">
        <div id="staff"></div>
    </div>
    <div class="message" id="message">ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
    
    <img id="rewardImage" class="reward-image" src="https://via.placeholder.com/300" alt="Reward">
    
    <div class="piano">
        <div class="key" data-note="C4">C</div> 
        <div class="key black" data-note="C#4">C#</div>
        <div class="key" data-note="D4">D</div>
        <div class="key black" data-note="D#4">D#</div>
        <div class="key" data-note="E4">E</div>
        <div class="key" data-note="F4">F</div>
        <div class="key black" data-note="F#4">F#</div>
        <div class="key" data-note="G4">G</div>
        <div class="key black" data-note="G#4">G#</div>
        <div class="key" data-note="A4">A</div>
        <div class="key black" data-note="A#4">A#</div>
        <div class="key" data-note="B4">B</div>
        <div class="key" data-note="C5">C5</div>
    </div>
    
    <script>
        let synth;
        let correctNote;
        let attempts = 0;
        let mistakes = 0;
        let consecutiveCorrect = 0;
        let score = 0;
        let responseTimes = [];
        let mistakeCount = {};
        let startTime;
        const maxAttempts = 10;
        const baseScore = 10;
        const fastBonus = 20;
        const penalty = -10;

        document.getElementById("startGameButton").addEventListener("click", () => {
            resetGame();
            document.getElementById("message").textContent = "éŸ³ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„";
            document.getElementById("startAudioButton").disabled = false;
        });

        function resetGame() {
            attempts = 0;
            mistakes = 0;
            score = 0;
            responseTimes = [];
            mistakeCount = {};
            consecutiveCorrect = 0;
            document.getElementById("rewardImage").style.display = "none";
        }

        document.getElementById("startAudioButton").addEventListener("click", async () => {
            await Tone.start();
            alert("éŸ³ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼");
            synth = new Tone.Synth().toDestination();
            document.getElementById("message").textContent = "ã‚²ãƒ¼ãƒ é–‹å§‹ï¼éŸ³ç¬¦ã‚’å½“ã¦ã¦ãã ã•ã„";
            generateRandomNote();
        });

        async function playNote(note) {
            console.log('playNote start!')
            // AudioContext ãŒä¸€æ™‚åœæ­¢ã—ã¦ã„ãŸã‚‰å†é–‹
            if (Tone.context.state !== "running") {
                console.warn("AudioContext is suspended, restarting...");
                await Tone.start();
                console.log("AudioContext restarted");
            }
            if (!synth) {
                console.error("synth is not initialized");
                return;
            } 
            console.log("playing note:" , note)
            try {
                synth.triggerAttackRelease(note, "8n");
                console.log("note played:",  note)
            } catch (error) {
                console.error("Error playing note:", error);
            }
            // synth.triggerAttackRelease(note, "8n");
            checkAnswer(note); // éŸ³ã‚’é³´ã‚‰ã—ã¦ã‹ã‚‰æ­£èª¤åˆ¤å®šï¼
            console.log("ãƒã‚§ãƒƒã‚¯ã‚¢ãƒ³ã‚µãƒ¼å®Ÿè¡Œ")
        }

        function drawStaff(note) {
            const staffDiv = document.getElementById("staff");
            staffDiv.innerHTML = "";
            const renderer = new Vex.Flow.Renderer(staffDiv, Vex.Flow.Renderer.Backends.SVG);
            renderer.resize(300, 200);
            const context = renderer.getContext();
            const stave = new Vex.Flow.Stave(25, 40, 250);
            stave.addClef("treble").setContext(context).draw();
            const staveNote = new Vex.Flow.StaveNote({
                keys: [note],
                duration: "q",
                clef: "treble"
            });
            const voice = new Vex.Flow.Voice({ num_beats: 1, beat_value: 4 });
            voice.addTickables([staveNote]);
            new Vex.Flow.Formatter().joinVoices([voice]).format([voice], 400);
            voice.draw(context, stave);
        }

        function generateRandomNote() {
            const notes = ["C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5"];
            let index = Math.floor(Math.random() * notes.length);
            correctNote = notes[index];
            // VexFlow ã®å½¢å¼ã«å¤‰æ›ï¼ˆC4 â†’ C/4ï¼‰
            let vexflowNote = correctNote.charAt(0) + "/" + correctNote.charAt(1);
            console.log("Generated note:", correctNote, "VexFlow note:", vexflowNote);
            drawStaff(vexflowNote);
            // playNote(correctNote);
            startTime = Date.now();
        }

        function checkAnswer(selectedNote) {
            let responseTime = (Date.now() - startTime) / 1000;
            if (selectedNote === correctNote) {
//                let points = responseTime <= 2.0 ? fastBonus : baseScore;

                let points;
                if (responseTime <= 2.0) {
                    points = fastBonus; // 2ç§’ä»¥å†…ãªã‚‰ãƒœãƒ¼ãƒŠã‚¹ç‚¹ã‚’é©ç”¨
                    document.getElementById("message").textContent = `ã¯ã‚„ã„ï¼ã›ã„ã‹ã„ï¼+${points}ã¦ã‚“`;
                } else {
                    points = baseScore; // 2ç§’ä»¥ä¸Šãªã‚‰é€šå¸¸ã®ç‚¹æ•°
                    document.getElementById("message").textContent = `ã›ã„ã‹ã„ï¼+${points}ã¦ã‚“`;
                }
                console.log("responseTime " , responseTime)
                score += points;
                responseTimes.push({ note: correctNote, time: responseTime });
                //document.getElementById("message").textContent = `ã›ã„ã‹ã„ï¼+${points}ã¦ã‚“`;
                attempts++;
                if (attempts >= maxAttempts) {
                    endGame();ã€€
                }else {
                    setTimeout(generateRandomNote, 1000);
                    console.log('settimeout å®Ÿè¡Œ');
                }
                
            } else {
                score += penalty;
                mistakes++;
                mistakeCount[selectedNote] = (mistakeCount[selectedNote] || 0) + 1;
                document.getElementById("message").textContent = `ã‚‚ã†ã„ã¡ã©ï¼${penalty}ã¦ã‚“`;
            }
            // attempts++;
            // if (attempts >= maxAttempts) endGame();
            // else etTimeosut(generateRandomNote, 1000);
        }

        function endGame() {
            let totalTime = responseTimes.reduce((sum, r) => sum + r.time, 0);
            let avgTime = totalTime / responseTimes.length || 0;

            responseTimes.sort((a, b) => a.time - b.time);
            let fastest = responseTimes.slice(0, 3);
            let slowest = responseTimes.slice(-3);

            let mistakesSorted = Object.entries(mistakeCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);

            let resultMessage = `
                <p>ğŸµ ã‚²ãƒ¼ãƒ çµ‚äº† ğŸµ</p>
                <p><strong>åˆè¨ˆå¾—ç‚¹:</strong> ${score}</p>
                <p><strong>ã‹ã‹ã£ãŸæ™‚é–“:</strong> ${totalTime.toFixed(2)} ç§’</p>
                <p><strong>æ­£è§£ã®æ•°:</strong> ${responseTimes.length}</p>
                <p><strong>é–“é•ãˆãŸæ•°:</strong> ${mistakes}</p>
                <p><strong>å¹³å‡ã®åå¿œæ™‚é–“:</strong> ${avgTime.toFixed(2)} ç§’</p>
                <p><strong>åå¿œãŒæ—©ã‹ã£ãŸéŸ³ãƒˆãƒƒãƒ—3:</strong> ${fastest.map(n => `${n.note}(${n.time.toFixed(2)}ç§’)`).join(", ")}</p>
                <p><strong>åå¿œãŒé…ã‹ã£ãŸéŸ³ãƒˆãƒƒãƒ—3:</strong> ${slowest.map(n => `${n.note}(${n.time.toFixed(2)}ç§’)`).join(", ")}</p>
                <p><strong>é–“é•ã„ã®å¤šã‹ã£ãŸéŸ³ãƒˆãƒƒãƒ—3:</strong> ${mistakesSorted.map(m => `${m[0]}(${m[1]}å›)`).join(", ")}</p>
            `;

            // alert(resultMessage);
            // çµæœã‚’ç”»é¢ä¸­å¤®ã«è¡¨ç¤º
            document.getElementById("resultText").innerHTML = resultMessage;
            document.getElementById("resultContainer").style.display = "block";
        }


        document.querySelectorAll('.key').forEach(key => {
            key.addEventListener('mousedown', () => {
                const note = key.dataset.note;
                playNote(note);
            });
            key.addEventListener('touchstart', (event) => {
                
                event.preventDefault();
                const note = event.target.dataset.note;
                console.log('const note by touch' , note)
                playNote(note);
                console.log('playnote by touch',  note)
            });
        });
    </script>

    <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ -->
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
      var vConsole = new VConsole();
      console.log('Hello console!');
    </script>   
</body>
</html>
